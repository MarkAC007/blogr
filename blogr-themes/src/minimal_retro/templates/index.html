{% extends "base.html" %}

{% block title %}{{ site.blog.title }}{% endblock %}

{% block content %}
<div class="posts-container">
    {% if posts %}
        {% for post in posts %}
        <article class="post-entry" data-post-id="{{ loop.index }}">
            <!-- Post Header -->
            <header class="post-entry-header" onclick="togglePost({{ loop.index }})">
                <h2 class="post-entry-title">{{ post.metadata.title }}</h2>
                
                <div class="post-entry-meta">
                    <time class="post-date">{{ post.metadata.date | date(format="%b %d, %Y") }}</time>
                    
                    {% if post.metadata.author %}
                    <span class="post-author">{{ post.metadata.author }}</span>
                    {% endif %}
                    
                    {% if post.reading_time %}
                    <span class="reading-time">{{ post.reading_time }}min</span>
                    {% endif %}
                </div>

                <!-- Tags as artistic elements -->
                {% if post.metadata.tags %}
                <div class="post-tags-preview">
                    {% for tag in post.metadata.tags %}
                    <span class="tag-bubble">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Expand indicator -->
                <div class="expand-indicator">
                    <span class="expand-text">read</span>
                    <span class="expand-arrow">↓</span>
                </div>
            </header>

            <!-- Expandable Content -->
            <div class="post-entry-content" id="post-content-{{ loop.index }}">
                {% if post.metadata.description %}
                <div class="post-description">
                    {{ post.metadata.description }}
                </div>
                {% endif %}
                
                <div class="post-full-content">
                    {{ post.content | safe }}
                </div>

                <!-- Post Footer with full tags -->
                <footer class="post-entry-footer">
                    {% if post.metadata.tags %}
                    <div class="post-tags-full">
                        <span class="tags-label">tagged:</span>
                        {% for tag in post.metadata.tags %}
                        <a href="{{ url(path='tags/' ~ tag ~ '.html') | safe }}" class="tag-link">{{ tag }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="post-actions">
                        <a href="{{ url(path='posts/' ~ post.metadata.slug ~ '.html') | safe }}" class="permalink">permalink</a>
                        <button class="collapse-btn" onclick="togglePost({{ loop.index }})">collapse</button>
                    </div>
                </footer>
            </div>
        </article>
        {% endfor %}
    {% else %}
    <div class="empty-state">
        <h2>No posts yet</h2>
        <p>This space is waiting for stories to fill it.</p>
    </div>
    {% endif %}
</div>

<!-- Loading indicator for infinite scroll -->
<div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
    <div class="loading-spinner">Loading more posts...</div>
</div>

<!-- End of posts indicator -->
<div id="end-of-posts" style="display: none; text-align: center; padding: 20px; color: #666;">
    <p>✨ You've reached the end!</p>
</div>

<script>
let currentPage = 1;
let isLoading = false;
let hasMorePosts = {{ has_more | default(value="false") }};
let totalPosts = {{ total_posts | default(value=0) }};
let loadedPosts = {{ posts | length | default(value=0) }};
let maxPostId = {{ posts | length | default(value=0) }};

function togglePost(postId) {
    const content = document.getElementById('post-content-' + postId);
    const article = document.querySelector('[data-post-id="' + postId + '"]');
    const arrow = article.querySelector('.expand-arrow');
    const text = article.querySelector('.expand-text');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        article.classList.remove('expanded');
        arrow.textContent = '↓';
        text.textContent = 'read';
    } else {
        // Close other expanded posts
        document.querySelectorAll('.post-entry-content.expanded').forEach(el => {
            el.classList.remove('expanded');
        });
        document.querySelectorAll('.post-entry.expanded').forEach(el => {
            el.classList.remove('expanded');
            el.querySelector('.expand-arrow').textContent = '↓';
            el.querySelector('.expand-text').textContent = 'read';
        });
        
        // Open this post
        content.classList.add('expanded');
        article.classList.add('expanded');
        arrow.textContent = '↑';
        text.textContent = 'close';
        
        // Smooth scroll to post
        article.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Close expanded posts when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.post-entry')) {
        document.querySelectorAll('.post-entry-content.expanded').forEach(el => {
            el.classList.remove('expanded');
        });
        document.querySelectorAll('.post-entry.expanded').forEach(el => {
            el.classList.remove('expanded');
            el.querySelector('.expand-arrow').textContent = '↓';
            el.querySelector('.expand-text').textContent = 'read';
        });
    }
});

// Infinite scroll functionality
async function loadMorePosts() {
    if (isLoading || !hasMorePosts) return;
    
    isLoading = true;
    document.getElementById('loading-indicator').style.display = 'block';
    
    try {
        // Try static JSON file first (for deployed sites)
        let response;
        let data;
        
        try {
            response = await fetch(`/api/posts-page-${currentPage + 1}.json`);
            if (!response.ok) throw new Error('Static file not found');
            data = await response.json();
        } catch (staticError) {
            // Fallback to dynamic API (for development server)
            response = await fetch(`/api/posts?page=${currentPage + 1}&limit=10`);
            if (!response.ok) throw new Error('API endpoint not available');
            data = await response.json();
        }
        
        if (data.posts && data.posts.length > 0) {
            const postsContainer = document.querySelector('.posts-container');
            
            data.posts.forEach((post, index) => {
                maxPostId++;
                const postElement = createPostElement(post, maxPostId);
                postsContainer.appendChild(postElement);
            });
            
            currentPage++;
            hasMorePosts = data.has_more;
            loadedPosts += data.posts.length;
            
            if (!hasMorePosts) {
                document.getElementById('end-of-posts').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Failed to load more posts:', error);
    } finally {
        isLoading = false;
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

function createPostElement(post, postId) {
    const article = document.createElement('article');
    article.className = 'post-entry';
    article.setAttribute('data-post-id', postId);
    
    // Format date
    const date = new Date(post.metadata.date);
    const formattedDate = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
    
    // Build tags HTML
    let tagsHtml = '';
    if (post.metadata.tags && post.metadata.tags.length > 0) {
        tagsHtml = `
            <div class="post-tags-preview">
                ${post.metadata.tags.map(tag => `<span class="tag-bubble">${tag}</span>`).join('')}
            </div>
        `;
    }
    
    let tagsFullHtml = '';
    if (post.metadata.tags && post.metadata.tags.length > 0) {
        tagsFullHtml = `
            <div class="post-tags-full">
                <span class="tags-label">tagged:</span>
                ${post.metadata.tags.map(tag => `<a href="tags/${tag}.html" class="tag-link">${tag}</a>`).join(', ')}
            </div>
        `;
    }
    
    article.innerHTML = `
        <header class="post-entry-header" onclick="togglePost(${postId})">
            <h2 class="post-entry-title">${post.metadata.title}</h2>
            
            <div class="post-entry-meta">
                <time class="post-date">${formattedDate}</time>
                
                ${post.metadata.author ? `<span class="post-author">${post.metadata.author}</span>` : ''}
                
                ${post.reading_time ? `<span class="reading-time">${post.reading_time}min</span>` : ''}
            </div>

            ${tagsHtml}

            <div class="expand-indicator">
                <span class="expand-text">read</span>
                <span class="expand-arrow">↓</span>
            </div>
        </header>

        <div class="post-entry-content" id="post-content-${postId}">
            ${post.metadata.description ? `<div class="post-description">${post.metadata.description}</div>` : ''}
            
            <div class="post-full-content">
                ${post.content}
            </div>

            <footer class="post-entry-footer">
                ${tagsFullHtml}

                <div class="post-actions">
                    <a href="posts/${post.metadata.slug}.html" class="permalink">permalink</a>
                    <button class="collapse-btn" onclick="togglePost(${postId})">collapse</button>
                </div>
            </footer>
        </div>
    `;
    
    return article;
}

// Scroll event listener for infinite scroll
let scrollTimeout;
window.addEventListener('scroll', function() {
    if (scrollTimeout) {
        clearTimeout(scrollTimeout);
    }
    
    scrollTimeout = setTimeout(function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
            loadMorePosts();
        }
    }, 100);
});

// Initial check if we need to load more posts (in case the page is short)
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (document.body.offsetHeight <= window.innerHeight && hasMorePosts) {
            loadMorePosts();
        }
    }, 100);
});
</script>
{% endblock %}